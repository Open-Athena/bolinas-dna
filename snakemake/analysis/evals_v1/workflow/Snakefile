"""Snakemake workflow for evaluating genomic language models."""


configfile: "config/config.yaml"


# Helper functions (defined before includes so they're available in all rule files)
def get_all_datasets():
    """Get list of all dataset names."""
    return [d["name"] for d in config["datasets"]]


def get_all_model_steps():
    """Get list of all (model_name, step) combinations."""
    combinations = []
    for model in config["models"]:
        for step in model["steps"]:
            combinations.append((model["name"], step))
    return combinations


def get_custom_plot_config(plot_name):
    """Get configuration for a specific custom plot."""
    if "custom_plots" not in config:
        raise ValueError("No custom_plots defined in config")
    for plot in config["custom_plots"]:
        if plot["name"] == plot_name:
            return plot
    raise ValueError(f"Custom plot {plot_name} not found in config")


def get_all_custom_plot_names():
    """Get list of all custom plot names."""
    if "custom_plots" not in config:
        return []
    return [plot["name"] for plot in config["custom_plots"]]


# Include rule files
include: "rules/inference.smk"
include: "rules/metrics.smk"
include: "rules/plots.smk"


# Define all output targets
rule all:
    input:
        # All metrics files (cartesian product of datasets and model_steps)
        [
            f"results/metrics/{dataset}/{model}/{step}.parquet"
            for dataset in get_all_datasets()
            for model, step in get_all_model_steps()
        ],
        # Plots for each model
        [
            f"results/plots/metrics_vs_step/{model}.svg"
            for model in [m["name"] for m in config["models"]]
        ],
        # Model comparison plots for each score type
        [
            f"results/plots/models_comparison/{score_type}.svg"
            for score_type in config["score_types"]
        ],
        # Custom filtered comparison plots
        [
            f"results/plots/custom_comparison/{plot_name}.svg"
            for plot_name in get_all_custom_plot_names()
        ],


# Download genome reference
rule download_genome:
    output:
        "results/genome.fa.gz",
    params:
        url=config["genome_url"],
    shell:
        "wget {params.url} -O {output}"
