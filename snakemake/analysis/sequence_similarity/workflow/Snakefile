"""Snakemake workflow for analyzing sequence similarity across genomic datasets.

This pipeline measures sequence similarity between validation and training splits
across different taxonomic scales to understand potential data leakage in
genomic language model training using MMseqs2 clustering.

References:
- ESM2: https://www.science.org/doi/10.1126/science.ade2574
- Chao et al.: https://www.biorxiv.org/content/10.64898/2025.12.22.695963v1
- hashFrag: https://www.biorxiv.org/content/10.1101/2025.01.22.634321v1
"""

configfile: "config/config.yaml"


def get_all_datasets():
    """Get list of all dataset names."""
    return [d["name"] for d in config["datasets"]]


def get_all_identity_thresholds():
    """Get list of all identity thresholds to test (MMseqs2)."""
    return config["mmseqs2"]["identity_thresholds"]


def get_sanity_check_identity_thresholds():
    """Get identity thresholds for sanity check."""
    return config["sanity_check"]["identity_thresholds"]


def get_sanity_check_coverage_thresholds():
    """Get coverage thresholds for sanity check."""
    return config["sanity_check"]["coverage_thresholds"]


# Include rule files
include: "rules/common.smk"
include: "rules/download.smk"
include: "rules/clustering.smk"
include: "rules/analysis.smk"
include: "rules/tests.smk"


# =============================================================================
# Main targets
# =============================================================================

rule all:
    """Run MMseqs2 clustering analysis."""
    input:
        # Sanity check (validation set is identical across datasets)
        "results/sanity_check/humans/summary.parquet",
        # MMseqs2 clustering analysis
        "results/analysis/leakage_summary.parquet",
        "results/plots/leakage_heatmap.png",
        "results/plots/leakage_by_threshold.png",


# =============================================================================
# Individual analysis targets
# =============================================================================

rule sanity_check:
    """Run only the sanity check (validation self-similarity analysis).

    This clusters validation sequences against themselves to verify:
    - RC handling: sequences should cluster with their reverse complement
    - Overlap handling: adjacent windows should show similarity

    Usage: snakemake sanity_check --cores 8
    """
    input:
        # Validation set is identical across all datasets, so only run once
        "results/sanity_check/humans/summary.parquet",


rule mmseqs2_analysis:
    """Run only MMseqs2 clustering analysis.

    Fast O(N) clustering at multiple identity thresholds.

    Usage: snakemake mmseqs2_analysis --cores 16
    """
    input:
        expand(
            "results/clustering/{dataset}/clusters_{identity}.tsv",
            dataset=get_all_datasets(),
            identity=get_all_identity_thresholds(),
        ),
        "results/analysis/leakage_summary.parquet",
        "results/plots/leakage_heatmap.png",
        "results/plots/leakage_by_threshold.png",


